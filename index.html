<script>
  const base = "https://slideui.github.io/block-images";
  const api = "https://api.github.com/repos/slideui/block-images/contents";
  const gallery = document.getElementById("gallery");
  const catSelect = document.getElementById("category");
  const cache = {};

  async function loadCategories() {
    const res = await fetch(api);
    const data = await res.json();
    const folders = data.filter(item => item.type === "dir").map(item => item.name);
    catSelect.innerHTML = "";
    folders.forEach(name => {
      const opt = document.createElement("option");
      opt.textContent = name;
      catSelect.appendChild(opt);
    });
    catSelect.value = "404";
  }

  async function loadImages() {
    const category = catSelect.value;
    const device = document.getElementById("device").value;
    const mode = document.getElementById("mode").value;
    const key = `${category}-${device}-${mode}`;
    gallery.innerHTML = "<p>Loadingâ€¦</p>";

    if (cache[key]) {
      gallery.innerHTML = cache[key];
      return;
    }

    const images = [];
    for (let i = 1; i <= 400; i++) {
      const filename = `${category} Blocks-${i}_result_result.webp`;
      const url = `${base}/${encodeURIComponent(category)}/${device}/${mode}/${encodeURIComponent(filename)}`;
      const res = await fetch(url, { method: "HEAD" });
      if (res.ok) images.push(url);
    }

    const html = images
      .map(src => `<img src="${src}" loading="lazy" alt="${category}" />`)
      .join("");
    cache[key] = html;
    gallery.innerHTML = html || "No images found.";
  }

  async function init() {
    await loadCategories();
    loadImages();
  }

  document.getElementById("device").addEventListener("change", loadImages);
  document.getElementById("mode").addEventListener("change", loadImages);
  catSelect.addEventListener("change", loadImages);

  init();
</script>
